server:
  port: 8080

spring:
  application:
    name: api-gateway

  cloud:
    gateway:
      server:
        webflux:
          discovery:
            locator:
              enabled: true
              lower-case-service-id: true

          routes:
            # Auth Server Routes (Write Operations)
            - id: auth-register
              uri: lb://auth-server
              predicates:
                - Path=/auth/register
              filters:
                - RewritePath=/auth/register, /auth/register

            - id: auth-oauth
              uri: lb://auth-server
              predicates:
                - Path=/oauth2/**

            # User read operations -> user-service (cached replica)
            - id: user-read-operations
              uri: lb://user-service
              predicates:
                - Path=/api/users/profile/**
                - Method=GET
              filters:
                - name: CircuitBreaker
                  args:
                    name: userServiceCircuitBreaker
                    fallbackUri: forward:/fallback/user-service

            # User admin read operations -> user-service
            - id: user-admin-read-operations
              uri: lb://user-service
              predicates:
                - Path=/api/users/admin/**
                - Method=GET
              filters:
                - name: CircuitBreaker
                  args:
                    name: userServiceAdminCircuitBreaker
                    fallbackUri: forward:/fallback/user-service

            # User write operations -> auth-server (master)
            - id: user-write-operations
              uri: lb://auth-server
              predicates:
                - Path=/api/users/profile/**
                - Method=PUT,PATCH,DELETE
              filters:
                # Rewrite /api/users/profile/{userId} -> /users/{userId}
                - RewritePath=/api/users/profile/(?<userId>[^/]+), /users/${userId}

            # User admin mutations -> auth-server (master)
            - id: user-admin-write-operations
              uri: lb://auth-server
              predicates:
                - Path=/api/users/admin/**
                - Method=PUT,PATCH,DELETE
              filters:
                # Rewrite /api/users/admin/... -> /users/...
                - RewritePath=/api/users/admin/(?<segment>.*), /users/${segment}

eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus

logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web: DEBUG
    org.springframework.http: DEBUG
    org.springframework.boot.autoconfigure: INFO

