server:
  port: 8080

spring:
  application:
    name: api-gateway

  cloud:
    gateway:
      server:
        webflux:
          default-filters:
            - DedupeResponseHeader=Access-Control-Allow-Credentials Access-Control-Allow-Origin
          discovery:
            locator:
              enabled: false # Disabled to avoid conflicts with manual routes
              lower-case-service-id: true
          routes:

            # --------------------------------------------------
            # OPENAPI ROUTES (MUST BE FIRST)
            # --------------------------------------------------
            - id: auth-server-openapi
              uri: lb://auth-server
              predicates:
                - Path=/auth-server/v3/api-docs/**
              filters:
                - RewritePath=/auth-server/(?<segment>.*), /${segment}

            - id: exam-service-openapi
              uri: lb://exam-service
              predicates:
                - Path=/exam-service/v3/api-docs/**
              filters:
                - RewritePath=/exam-service/(?<segment>.*), /${segment}

            - id: question-service-openapi
              uri: lb://question-service
              predicates:
                - Path=/question-service/v3/api-docs/**
              filters:
                - RewritePath=/question-service/(?<segment>.*), /${segment}

            - id: user-service-openapi
              uri: lb://user-service
              predicates:
                - Path=/user-service/v3/api-docs/**
              filters:
                - RewritePath=/user-service/(?<segment>.*), /${segment}

            - id: attempt-service-openapi
              uri: lb://attempt-service
              predicates:
                - Path=/attempt-service/v3/api-docs/**
              filters:
                - RewritePath=/attempt-service/(?<segment>.*), /${segment}

            - id: result-service-openapi
              uri: lb://result-service
              predicates:
                - Path=/result-service/v3/api-docs/**
              filters:
                - RewritePath=/result-service/(?<segment>.*), /${segment}

            - id: notification-service-openapi
              uri: lb://notification-service
              predicates:
                - Path=/notification-service/v3/api-docs/**
              filters:
                - RewritePath=/notification-service/(?<segment>.*), /${segment}

            # --------------------------------------------------
            # FILE ROUTE
            # --------------------------------------------------
            - id: user-service-files
              uri: lb://user-service
              predicates:
                - Path=/files/**

            # --------------------------------------------------
            # API ROUTES (ORDER MATTERS - MORE SPECIFIC FIRST!)
            # --------------------------------------------------

            # Auth Server - Admin User Management endpoints (most specific first)
            - id: auth-server-admin-user-search
              uri: lb://auth-server
              predicates:
                - Path=/api/admin/users/search
              filters:
                - name: CircuitBreaker
                  args:
                    name: authServiceCircuitBreaker
                    fallbackUri: forward:/fallback/auth-server

            - id: auth-server-admin-user-actions
              uri: lb://auth-server
              predicates:
                - Path=/api/admin/users/{id}/enable,/api/admin/users/{id}/disable,/api/admin/users/{id}/lock,/api/admin/users/{id}/unlock
              filters:
                - name: CircuitBreaker
                  args:
                    name: authServiceCircuitBreaker
                    fallbackUri: forward:/fallback/auth-server

            - id: auth-server-admin-user-single
              uri: lb://auth-server
              predicates:
                - Path=/api/admin/users/{id}
                - Method=GET,DELETE
              filters:
                - name: CircuitBreaker
                  args:
                    name: authServiceCircuitBreaker
                    fallbackUri: forward:/fallback/auth-server

            - id: auth-server-admin-user-list
              uri: lb://auth-server
              predicates:
                - Path=/api/admin/users
                - Method=GET
              filters:
                - name: CircuitBreaker
                  args:
                    name: authServiceCircuitBreaker
                    fallbackUri: forward:/fallback/auth-server

            # Auth Server - Other routes
            - id: auth-server-routes
              uri: lb://auth-server
              predicates:
                - Path=/oauth2/**,/login/**,/logout/**,/api/auth/**,/.well-known/**
              filters:
                - PreserveHostHeader

            # User Service - Profile endpoints (after auth-server user management)
            - id: user-service
              uri: lb://user-service
              predicates:
                - Path=/api/profiles/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: userServiceCircuitBreaker
                    fallbackUri: forward:/fallback/user-service

            - id: exam-service
              uri: lb://exam-service
              predicates:
                - Path=/api/exams/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: examServiceCircuitBreaker
                    fallbackUri: forward:/fallback/exam-service

            - id: question-service
              uri: lb://question-service
              predicates:
                - Path=/api/questions/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: questionServiceCircuitBreaker
                    fallbackUri: forward:/fallback/question-service

            - id: attempt-service
              uri: lb://attempt-service
              predicates:
                - Path=/api/attempts/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: attemptServiceCircuitBreaker
                    fallbackUri: forward:/fallback/attempt-service

            - id: result-service
              uri: lb://result-service
              predicates:
                - Path=/api/results/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: resultServiceCircuitBreaker
                    fallbackUri: forward:/fallback/result-service

            - id: notification-service
              uri: lb://notification-service
              predicates:
                - Path=/api/notifications/**
              filters:
                - name: CircuitBreaker
                  args:
                    name: notificationServiceCircuitBreaker
                    fallbackUri: forward:/fallback/notification-service

          globalcors:
            cors-configurations:
              '[/**]':
                allowedOriginPatterns: "*"
                allowedMethods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
                allowedHeaders: "*"
                allowCredentials: true
                maxAge: 3600

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${SPRING_SECURITY_OAUTH2_RESOURCESERVER_JWT_ISSUER_URI:http://localhost:9000}
app:
  frontend-url: http://localhost:3000

eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:8761/eureka/

  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}

    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30

    home-page-url: http://localhost:${server.port}/
    status-page-url: http://localhost:${server.port}/actuator/info
    health-check-url: http://localhost:${server.port}/actuator/health


management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,gateway,routes
  endpoint:
    health:
      show-details: always
    gateway:
      access: read_only

springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs

  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: Auth Server
        url: /auth-server/v3/api-docs
      - name: Exam Service
        url: /exam-service/v3/api-docs
      - name: Question Service
        url: /question-service/v3/api-docs
      - name: User Service
        url: /user-service/v3/api-docs
      - name: Attempt Service
        url: /attempt-service/v3/api-docs
      - name: Result Service
        url: /result-service/v3/api-docs
      - name: Notification Service
        url: /notification-service/v3/api-docs
    urls-primary-name: Auth Server
    oauth:
      client-id: oerms-client
      client-secret: secret
      scopes: [openid, profile, email]
      use-pkce-with-authorization-code-grant: true
    config-url: /v3/api-docs/swagger-config
    display-operation-id: false
    display-request-duration: true
    filter: true
    operations-sorter: method
    tags-sorter: alpha
    try-it-out-enabled: true
    persist-authorization: true
    validator-url: none

resilience4j:
  circuitbreaker:
    configs:
      default:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
    instances:
      authServiceCircuitBreaker:
        base-config: default
      examServiceCircuitBreaker:
        base-config: default
      questionServiceCircuitBreaker:
        base-config: default
      userServiceCircuitBreaker:
        base-config: default
      attemptServiceCircuitBreaker:
        base-config: default
      resultServiceCircuitBreaker:
        base-config: default
      notificationServiceCircuitBreaker:
        base-config: default

logging:
  level:
    root: INFO
    org.springframework: WARN
    org.springframework.cloud.gateway: INFO
    org.springframework.web: WARN
    reactor.netty: WARN
    reactor.netty.http.client: INFO
    org.springdoc: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} %-5level [%logger{36}] - %msg%n"
